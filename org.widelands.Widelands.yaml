app-id: org.widelands.Widelands
default-branch: beta
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
# For compiling with clang:
#sdk-extensions:
#  - org.freedesktop.Sdk.Extension.llvm16
command: widelands
desktop-file-name-suffix: ' (Beta)'
tags:
  - beta
finish-args:
  # wayland
  - --socket=wayland
  - --env=SDL_VIDEODRIVER=wayland,x11
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Play sounds
  - --socket=pulseaudio
  # Needs to talk to the network
  - --share=network
  - --persist=.widelands
  # OpenGL access
  - --device=dri
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json

  - name: asio
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/asio/asio/1.30.2%20%28Stable%29/asio-1.30.2.tar.bz2
        sha256: 9f12cef05c0477eace9c68ccabd19f9e3a04b875d4768c323714cbd3a5fa3c2b
    # This is to skip the 'make' step (building the examples), because
    # I couldn't figure out how to do it using the default buildsystem
    buildsystem: simple
    build-commands:
      - |
        # This all could be just a 'cp -a', but let's have the better
        # error handling of GNU 'install'
        ./configure --prefix=${FLATPAK_DEST}
        make install-data


  ####### Widelands #######

  - name: Widelands
    build-options:
      env:
        # This is needed to set the version string for development versions
        # without 'disable-shallow-clone: true'
        # (use utils/detect_revision.py in a complete git tree to get it)
        WL_VERSION: 1.3~git26838 (50fb7e6@master)

        # We have to set this manually for RC versions:
        # WL_RELEASE_DATE: 2024-11-10

        # Use clang instead of GCC
        #CC:  /usr/lib/sdk/llvm16/bin/clang
        #CXX: /usr/lib/sdk/llvm16/bin/clang++

      ldflags: -lGL
    sources:
      # Use this for development versions:
      - type: git
        url: https://github.com/widelands/widelands.git
        commit: 50fb7e6f24e524ae63549761ba1f04381d6cbba5

      # Use this for RC:
      # - type: archive
      #   url: https://github.com/widelands/widelands/archive/refs/tags/v1.2.1-rc2.tar.gz
      #   sha256: 187dc471feca35a5688a947e0357a32a1cdd70b77efe4398e3f347dd53ad0f17

      - type: shell
        commands:
        - |
          SANITY_WARNING="Exactly one of WL_VERSION or WL_RELEASE_DATE must be set."

          if [ -z "$WL_RELEASE_DATE" ]
          then
            if [ -z "$WL_VERSION" ]
            then
              echo "$SANITY_WARNING"
              exit 1
            fi

            # Development version

            # Check versions in manifest
            if [ "$(echo "$WL_VERSION" | sed -E 's/.*\(([0-9a-f]{7})@.*/\1/')" != \
                 "$(git show --abbrev=7 --no-patch --format='%h')" ]
            then
              echo "ERROR: Mismatch of commit hash and WL_VERSION in manifest!"
              exit 1;
            fi

            # Set version string
            echo "$WL_VERSION" >WL_RELEASE

            # Get release date from git
            WL_RELEASE_DATE="$(date --date="$(git show --no-patch --format='%cI')" --utc '+%Y-%m-%d')"

          else
            if [ -n "$WL_VERSION" ]
            then
              echo "$SANITY_WARNING"
              exit 1
            fi

            if [ -f WL_RELEASE ]
            then
              # RC version
              WL_VERSION="$(cat WL_RELEASE)"
            else
              echo "ERROR: WL_RELEASE is not set and WL_VERSION file is not found!"
              exit 1
            fi
          fi

          # Modify xdg/org.widelands.Widelands.appdata.xml.stub:
          #  * Set version
          #  * Remove the binary from provides, because flatpak doesn't export it
          cat >edit_appdata.sed <<EOF
          /<releases>/a \\
              <release date="${WL_RELEASE_DATE}" version="${WL_VERSION}"/>
          /<binary>/d
          EOF
          sed -f edit_appdata.sed <xdg/org.widelands.Widelands.appdata.xml.stub >appdata.stub.edited
          mv appdata.stub.edited xdg/org.widelands.Widelands.appdata.xml.stub
          rm edit_appdata.sed

          # Regenerate appdata.xml with the changes
          utils/update_appdata.py --nonet

    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
      # flatpak-builder-lint says this is redundant, but keep it for reference
      # -DCMAKE_INSTALL_PREFIX=/app
      - -DWL_INSTALL_BINDIR=/app/bin
      - -DWL_INSTALL_BASEDIR=/app/share/widelands
      - -DWL_INSTALL_DATADIR=/app/share/widelands
      - -DGLEW_ROOT=/app
      - -DGLEW_INCLUDE_DIR=/app/include/GL
      # Fix an issue with linking libs
      # https://www.widelands.org/forum/topic/1343/?page=3#post-9857
      - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
      # cmake ignores CPLUS_INCLUDE_PATH where Asio is installed
      - -DCMAKE_INCLUDE_PATH=/app/include
      - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a

