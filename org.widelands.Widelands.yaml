app-id: org.widelands.Widelands
default-branch: beta
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
command: widelands
desktop-file-name-suffix: ' (Beta)'
tags:
  - beta
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Play sounds
  - --socket=pulseaudio
  # Needs to talk to the network
  - --share=network
  - --persist=.widelands
  # OpenGL access
  - --device=dri
cleanup:
  - /bin/pip*
  - /bin/python*
  - /bin/smtpd.py
  - /include
  - /lib/debug/source/python*
  - /lib/libpython*
  - /lib/pkgconfig
  - /lib/python*
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - shared-modules/lua5.3/lua-5.3.5.json
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - shared-modules/python2.7/python-2.7.json

  - name: boost
    buildsystem: simple
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.72.0/source/boost_1_72_0.tar.bz2
        sha256: 59c9b274bc451cf91a9ba1dd2c7fdcaf5d60b1b3aa83f2c9fa143417cc660722
    build-commands:
      - ./bootstrap.sh --prefix="${FLATPAK_DEST}" --with-libraries=system,regex,test;
      - ./b2 -j"${FLATPAK_BUILDER_N_JOBS}" install;

  - name: xmlstarlet
    config-opts:
      - --disable-static-libs
      - --with-libxml-libs-prefix=/usr/lib
      - --with-libxml-include-prefix=/usr/include/libxml2
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz
        sha256: 15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .;
          - autoreconf -vfi;
    post-install:
      - ln -s "xml" "${FLATPAK_DEST}/bin/xmlstarlet" ||:;
    cleanup: ["*"]

  - name: Widelands
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app/bin
      - -DWL_INSTALL_BASEDIR=/app/share/widelands
      - -DWL_INSTALL_DATADIR=/app/share/widelands
      - -DBOOST_ROOT=/app
      - -DGLEW_ROOT=/app
      - -DGLEW_INCLUDE_DIR=/app/include/GL
      # Fix an issue with linking libs
      # https://www.widelands.org/forum/topic/1343/?page=3#post-9857
      - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
      - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
      - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
    build-options:
      ldflags: -lGL
    sources:
      - type: git
        url: https://github.com/widelands/widelands.git
        commit: 7747702abc474351e587d70fb60b3be7880cf214
        # Need full git history to generate revision number
        disable-shallow-clone: true
      # Generate a new version number with the git revision
      # https://github.com/widelands/widelands/issues/3558
      - type: shell
        commands:
          - |
            version_old="$( xmlstarlet sel -t -v '/component/releases/release[1]/@version' -n "xdg/${FLATPAK_ID}.appdata.xml" )";
            version_new="$( echo "${version_old}" | ruby -e 'puts $stdin.read.gsub(/([0-9]+)/) { |m| (m.to_i + 1).to_s }' )";
            WL_VERSION="$( python2 utils/detect_revision.py 2> /dev/null )";
            version_git="${WL_VERSION}";
            if [[ ! "${WL_VERSION}" =~ ^build-[0-9]+$ || "${WL_VERSION}" =~ ^r[0-9]+ ]]; then
              revision_git="${WL_VERSION%[*}";
              [[ -z "${revision_git}" ]] || version_git="${version_new}~${revision_git}";
            fi;
            echo "${version_git}" > "WL_VERSION";
            echo "${version_old}";
            echo "${version_git}";
          # Use a nicer version number (e.g. Build 21~r24271) instead of the default one (e.g. r24271[e8dd143@HEAD])
          # https://github.com/widelands/widelands/issues/3558#issuecomment-553563710
          #- cp -p "WL_VERSION" "WL_RELEASE";
    post-install:
      - |
        for f in "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml"; do
          # Remove all but the newest release from the AppData file, because appstream-glib is broken, and the file does not pass validation
          # https://github.com/hughsie/appstream-glib/pull/272#issuecomment-439812546
          xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' "${f}";
          # Put a new release into the AppData file
          # https://github.com/widelands/widelands/issues/3558#issuecomment-553567846
          version_old="$( xmlstarlet sel -t -v '/component/releases/release[1]/@version' -n "${f}" )";
          version_git="$( cat "../WL_VERSION" 2> /dev/null )";
          if [[ -n "${version_git}" && "${version_git}" != "${version_old}" ]]; then
            date_git="$( git log HEAD -1 --format="%at" 2> /dev/null | xargs -I{} date -d @{} +%Y-%m-%d 2> /dev/null )";
            xmlstarlet ed --inplace -i '/component/releases/release[1]' -t elem -n 'release' -s '/component/releases/release[1]' -t attr -n 'date' -v "${date_git}" -s '/component/releases/release[1]' -t attr -n 'version' -v "${version_git}" -s '/component/releases/release[1]' -t attr -n 'type' -v "development" "${f}";
          fi;
          # The provides tag describes the public interfaces this program provides
          # The binary tag is a child tag of the provides tag
          # It provides the name of a binary installed into a location in PATH
          # However, flatpak doesn't export any binaries on the host
          # https://www.freedesktop.org/software/appstream/docs/chap-Metadata.html#tag-provides
          xmlstarlet ed --inplace -d '/component/provides/binary' "${f}";
          xmlstarlet ed --inplace -d '/component/provides[not(./*) and (not(./text()) or normalize-space(./text())="")]' "${f}";
        done;
